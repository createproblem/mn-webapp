<?php

/*
* This file is part of the mn-webapp package.
*
* (c) createproblem <https://github.com/createproblem/>
*
* For the full copyright and license information, please view the LICENSE
* file that was distributed with this source code.
*/

namespace g5\MovieBundle\Entity;

use Doctrine\ORM\EntityRepository;
use g5\MovieBundle\Entity\Label;
use g5\AccountBundle\Entity\User;

/**
 * MovieRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MovieRepository extends EntityRepository
{
    public function findByLabel(Label $label, array $orderBy = null, $limit = null, $offset = null)
    {
        $qb = $this->createQueryBuilder('m');

        $qb->innerJoin('m.movieLabels', 'ml', 'WITH', 'ml.label = :label');
        $qb->setParameter(':label', $label);

        if ($offset !== null) {
            $qb->setFirstResult($offset);
        }

        if ($limit !== null) {
            $qb->setMaxResults($limit);
        }

        $q = $qb->getQuery();

        return $q->getResult();
    }

    /**
     * Loads random movies by user
     *
     * @param  User    $user
     *
     * @return array
     */
    public function findMovieIdsByUser(User $user)
    {
        $qb = $this->createQueryBuilder('m');
        $qb->select('m.id')
            ->where('m.user = :user')
            ->setParameter(':user', $user);

        $q = $qb->getQuery();

        return $q->getResult();
    }

    /**
     * @param  array  $movieIds
     *
     * @return array
     */
    public function findMoviesByIds(array $movieIds)
    {
        $qb = $this->createQueryBuilder('m');
        $qb->where($qb->expr()->in('m.id', $movieIds));

        $q = $qb->getQuery();

        return $q->getResult();
    }
}
